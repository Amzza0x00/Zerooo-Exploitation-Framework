import asyncio
import aiohttp
import socket

from zerooo.utils.data import random_ua, header_format
from zerooo.core.log import LOGGER
from zerooo.core.options import optProxy, optDebug


# def http_request_style(method, stream):
#     if method.lower() == 'post':
#         pass


def http_response_style(code, headers, body, context, stream_content):
    f_headers = header_format(headers)
    style = f'''Response: {code}\n{f_headers}\n{body}\n{context}\n{stream_content}
    '''
    return style


class HttpClient(object):

    def __init__(self):
        self.http_headers = {'User-Agent': random_ua()}
        self.http_timeout = 60
        self.verify_ssl = False
        self.http_allow_redirects = False
        self.proxy = optProxy.__get__()
        self.debug = optDebug.__get__()

    # async def send_request_cgi(self, method, url, rate=50, **kwargs):
    async def send_request_cgi(self, method, url, **kwargs):

        kwargs.setdefault('timeout', self.http_timeout)
        kwargs.setdefault('headers', self.http_headers)
        kwargs.setdefault('verify_ssl', self.verify_ssl)
        kwargs.setdefault('allow_redirects', self.http_allow_redirects)
        kwargs.setdefault('proxy', self.proxy)

        # 连接数限制 禁止dns缓存
        conn = aiohttp.TCPConnector(use_dns_cache=False)

        try:
            # async with asyncio.Semaphore(rate):
            async with aiohttp.ClientSession(connector=conn) as session:
                # async with aiohttp.ClientSession(connector=conn) as session:
                resp = await session.request(method, url, **kwargs)
                LOGGER.debug(f'Requests: {method} {url}', self.debug)
                text = await resp.text()
                content = await resp.read()
                stream_content = await resp.content.read()
                resp = {
                    'code': resp.status,
                    'text': text,
                    'content': content,
                    'url': resp.url,
                    'stream_content': stream_content,
                    'headers': resp.headers,
                    'cookie': resp.cookies
                }
                LOGGER.debug(http_response_style(resp['code'], resp['headers'], resp['text'], resp['content'],
                                                 resp['stream_content']), self.debug)
                return resp
        except aiohttp.ClientConnectorError:
            LOGGER.error(f'{url} Error: ConnectionError')
        except aiohttp.ServerDisconnectedError:
            LOGGER.error(f'{url} Error: ServerDisconnectedError')
        except aiohttp.InvalidURL:
            LOGGER.error(f'Invalid URL format: {url}')
        except socket.error as e:
            LOGGER.warning(e)
        except KeyboardInterrupt:
            LOGGER.warning('Module has been stopped')
        except asyncio.TimeoutError as e:
            pass
        except Exception as e:
            LOGGER.exception(e)

        return None
