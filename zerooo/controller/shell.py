# 处理getshell后的命令执行、反向shell、带外数据获取
'''
zsf (exp-rce) > run
info.. exploit success
----------------------------------------------------
1   www.zzz.com     windows     payload
2   www.zxc.com     linux       payload
----------------------------------------------------
zsf (exp-rce) > session
----------------------------------------------------
1   www.zzz.com     windows     payload
2   www.zxc.com     linux       payload
----------------------------------------------------
zsf (exp-rce) > session 1
zsf (exp-rce-1) shell > whoami
root
zsf (exp-rce) > use payload/linux/reversetcp
...
shell > whoami
root
zsf (exp-rce) > use payload/forget/dnslog
'''
from prettytable import PrettyTable, PLAIN_COLUMNS

from zerooo.core.common import IS_WIN


class ShellManage:

    def __init__(self):
        if IS_WIN:
            self.raw_prompt = '{} > '
        else:
            self.raw_prompt = '\001\033[4m\002{}\001\033[0m\002 > '

        self.prompt_hostname = self.raw_prompt.format('')

        self.shells = {}
        self.sn = 0

    def add_shell(self, url, os, payload):
        style = []
        self.sn += 1
        style.extend((url, os, payload))
        self.shells[self.sn] = style

    def is_shell(self, url):
        for i in self.shells.values():
            if url in i[0]:
                return True, i[1], i[2]

        return None, None, None

    def show_shell(self):
        tb = PrettyTable()
        tb.set_style(PLAIN_COLUMNS)
        print(f'\n会话管理 (Session manage):\n')
        tb.field_names = ['序号 (Sn)', '目标 (Target)', '系统 (System)', '模块 (Module)']
        tb.add_row(['---------', '-------------', '-------------', '------------'])
        for k, v in self.shells.items():
            tb.add_row([k, v[0], v[1], v[2]])

        tb.align = 'l'
        print(tb)
        print('\n')


shell_manage = ShellManage()
