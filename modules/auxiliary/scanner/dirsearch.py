import re

from zerooo.core.asyncpool import async_run
from zerooo.core.log import LOGGER
from zerooo.core.options import Option
from zerooo.request.httpclient import HttpClient
from zerooo.utils.data import parse_dict


class Zerooosploit(Option):

    def __init__(self):
        super(self.__class__, self).__init__()
        self.info = {
            'Name': 'Web目录扫描',
            'Module': 'auxiliary/scanner/dirsearch',
            'Product': 'scanner',
            'Cve': '',
            'Create_date': '20210409',
            'Description': '扫描Web敏感目录',
            'Authors': '01sec',
            'References': ''
        }

        self.option = {
            'target': {'Current Setting': 'https://www.baidu.com', 'Required': 'yes', 'Description': '目标地址（单一目标）'},
            'wordlist': {'Current Setting': 'wordlists/top7000.txt', 'Required': 'yes', 'Description': '字典路径'},
            'status': {'Current Setting': '200', 'Required': 'yes', 'Description': '提取指定状态码'}
        }

    async def spider(self, path):
        target = self.get_options('target')
        spider_url = target + path
        resp = await HttpClient().send_request_cgi('GET', spider_url)
        return resp

    def spider_callback(self, future):
        resp = future.result()
        status = int(self.get_options('status'))
        try:
            if resp['code'] == status:
                url = resp['url']
                title = re.findall('<title>(.*?)</title>', resp['text'])[0]
                msg = f'{url} - {status} - {title}'
                LOGGER.success(msg)
        except (TypeError, IndexError):
            pass

    def exploit(self):
        wordlist = self.get_options('wordlist')
        wordlists = []
        with open(parse_dict(wordlist), encoding='utf-8') as f:
            for i in f.readlines():
                wordlists.append(i.strip())

        async_run(self.spider, wordlists, self.spider_callback)
